<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Kanto 25</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: #2c3e50;
            color: white;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .battle-container {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 40px);
            margin: 0 auto;
            max-width: 1400px;
            box-sizing: border-box;
        }
        
        .team-sidebar {
            width: 200px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            height: fit-content;
            flex-shrink: 0;
        }
        
        .team-sidebar-title {
            color: #2c3e50;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .sidebar-pokemon {
            background: #f0f0f0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .sidebar-pokemon:hover {
            background: #e0e0e0;
            transform: scale(1.02);
            border-color: #2c3e50;
        }
        
        .sidebar-pokemon.active {
            border-color: #4CAF50;
            background: #e8f5e9;
        }
        
        .sidebar-pokemon.fainted {
            opacity: 0.6;
            cursor: not-allowed;
            background: #d3d3d3;
            border: 2px solid #ff4444;
        }
        
        .sidebar-pokemon.fainted:hover {
            transform: none;
            border-color: #ff4444;
        }
        
        .sidebar-pokemon img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            filter: brightness(1);
            transition: filter 0.3s ease;
        }
        
        .sidebar-pokemon.fainted img {
            filter: grayscale(100%) brightness(0.8);
        }
        
        .sidebar-pokemon-info {
            color: #2c3e50;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .sidebar-pokemon-name {
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .sidebar-pokemon-hp {
            height: 4px;
            background: #ddd;
            border-radius: 2px;
            margin: 3px 0;
            overflow: hidden;
        }
        
        .sidebar-pokemon-hp-fill {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }
        
        .sidebar-pokemon.fainted .sidebar-pokemon-hp-fill {
            background: #ff4444;
        }
        
        .battle-scene {
            background: linear-gradient(to bottom, #87CEEB, #E0F6FF);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-sizing: border-box;
        }
        
        .battle-content {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }
        
        .battle-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .pokemon-container {
            display: flex;
            justify-content: space-between;
            gap: 40px;
            flex: 1;
            min-height: 0;
        }
        
        .pokemon {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            flex: 1;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 0;
        }
        
        .pokemon img {
            width: 200px;
            height: 200px;
            object-fit: contain;
            transition: all 0.5s ease;
        }
        
        .pokemon.switching-out img {
            transform: scale(0);
            opacity: 0;
        }
        
        .pokemon.switching-in img {
            animation: switchIn 0.5s ease-out;
        }
        
        @keyframes switchIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .health-bar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .health-bar-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 100%;
            transition: width 1s ease-out;
        }
        
        .moves-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .battle-button {
            padding: 10px;
            font-size: 14px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .battle-button:hover {
            background-color: #c0392b;
        }
        
        .battle-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .battle-log {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 5px;
            width: 250px;
            overflow-y: auto;
            flex-shrink: 0;
            height: 100%;
            box-sizing: border-box;
        }
        
        .pokemon-name {
            font-size: 24px;
            color: #2c3e50;
            margin: 10px 0;
        }
        
        .pokemon-level {
            color: #2c3e50;
            font-size: 18px;
            margin: 5px 0;
        }
        
        .pokemon-stats {
            color: #2c3e50;
        }
        
        .turn-indicator {
            text-align: center;
            font-size: 20px;
            color: #2c3e50;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .team-selection {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .team-selection.active {
            display: block;
        }
        
        .team-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .team-pokemon {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .team-pokemon:hover {
            background: #e0e0e0;
            transform: scale(1.05);
            border-color: #2c3e50;
        }
        
        .team-pokemon.fainted {
            opacity: 0.6;
            cursor: not-allowed;
            background: #d3d3d3;
            border: 2px solid #ff4444;
        }
        
        .team-pokemon.fainted:hover {
            transform: none;
            border-color: #ff4444;
        }
        
        .team-pokemon img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            filter: brightness(1);
            transition: filter 0.3s ease;
        }
        
        .team-pokemon.fainted img {
            filter: grayscale(100%) brightness(0.8);
        }
        
        .team-pokemon .pokemon-status {
            color: #2c3e50;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .team-pokemon.fainted .pokemon-status {
            color: #ff4444;
        }
        
        .switch-prompt {
            text-align: center;
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .overlay.active {
            display: block;
        }
        /* Battle Animation Styles */
        
        .battle-animation {
            position: absolute;
            pointer-events: none;
            z-index: 100;
        }
        
        .electric-animation {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            animation: electric 0.5s ease-out;
        }
        
        .fire-animation {
            background: linear-gradient(45deg, #FF4500, #FF8C00);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            animation: fire 0.5s ease-out;
        }
        
        .water-animation {
            background: linear-gradient(45deg, #1E90FF, #00BFFF);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            animation: water 0.5s ease-out;
        }
        
        .grass-animation {
            background: linear-gradient(45deg, #32CD32, #228B22);
            width: 100px;
            height: 100px;
            border-radius: 50%;
            animation: grass 0.5s ease-out;
        }
        
        .normal-animation {
            background: linear-gradient(45deg, #A9A9A9, #808080);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            animation: normal 0.5s ease-out;
        }
        
        .dragon-animation {
            background: linear-gradient(45deg, #4169E1, #0000CD);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            animation: dragon 0.5s ease-out;
        }
        
        @keyframes electric {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes fire {
            0% {
                transform: scale(0) translateY(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) translateY(-20px);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) translateY(-40px);
                opacity: 0;
            }
        }
        
        @keyframes water {
            0% {
                transform: scale(0) translateX(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) translateX(20px);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) translateX(40px);
                opacity: 0;
            }
        }
        
        @keyframes grass {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        @keyframes normal {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
            100% {
                transform: scale(0);
                opacity: 0;
            }
        }
        
        @keyframes dragon {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
            100% {
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        .pokemon {
            position: relative;
        }
        
        .pokemon.hit {
            animation: hit 0.5s ease-in-out;
        }
        
        @keyframes hit {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-10px);
            }
            50% {
                transform: translateX(10px);
            }
            75% {
                transform: translateX(-5px);
            }
            100% {
                transform: translateX(0);
            }
        }
        
        .pokemon img.attacking {
            animation: attackJump 0.5s ease-out;
        }
        
        @keyframes attackJump {
            0% {
                transform: translateY(0);
            }
            25% {
                transform: translateY(-20px);
            }
            50% {
                transform: translateY(0);
            }
            75% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0);
            }
        }
        
        .battle-end-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            text-align: center;
            min-width: 300px;
        }
        
        .battle-end-popup.active {
            display: block;
        }
        
        .battle-end-popup h2 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 20px;
        }
        
        .battle-end-popup p {
            color: #2c3e50;
            font-size: 18px;
            margin-bottom: 25px;
        }
        
        .battle-end-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .battle-end-button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .battle-end-button.continue {
            background-color: #4CAF50;
            color: white;
        }
        
        .battle-end-button.quit {
            background-color: #e74c3c;
            color: white;
        }
        
        .battle-end-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: white;
            font-size: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .stats-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .stats-button:hover {
            background-color: #2980b9;
            transform: scale(1.05);
        }
        
        .trainer-stats-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            min-width: 400px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .trainer-stats-popup.active {
            display: block;
        }
        
        .stats-section {
            margin-bottom: 30px;
        }
        
        .stats-section h2 {
            color: #2c3e50;
            font-size: 24px;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        
        .battle-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .pokedex-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .pokedex-entry {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .pokedex-entry:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .pokedex-entry img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        .pokedex-entry .pokemon-name {
            color: #2c3e50;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loading-overlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">Loading Pokémon...</div>
        </div>
    </div>

    <div class="battle-container">
        <div class="team-sidebar">
            <div class="team-sidebar-title">Your Team</div>
            <div id="team-sidebar-content"></div>
        </div>
        <div class="battle-scene">
            <div class="battle-content">
                <div class="battle-main">
                    <div class="turn-indicator" id="turn-indicator">Select your moves!</div>
                    <div class="pokemon-container">
                        <div class="pokemon" id="player-pokemon">
                            <img id="player-sprite" src="" alt="Player Pokémon">
                            <div class="pokemon-name" id="player-name"></div>
                            <div class="pokemon-level" id="player-level"></div>
                            <div class="pokemon-stats" id="player-stats"></div>
                            <div class="health-bar">
                                <div class="health-bar-fill" id="player-health"></div>
                            </div>
                            <div class="moves-container" id="player-moves"></div>
                        </div>
                        <div class="pokemon" id="opponent-pokemon">
                            <img id="opponent-sprite" src="" alt="Opponent Pokémon">
                            <div class="pokemon-name" id="opponent-name"></div>
                            <div class="pokemon-level" id="opponent-level"></div>
                            <div class="pokemon-stats" id="opponent-stats"></div>
                            <div class="health-bar">
                                <div class="health-bar-fill" id="opponent-health"></div>
                            </div>
                            <div class="moves-container" id="opponent-moves"></div>
                        </div>
                    </div>
                </div>
                <div class="battle-log" id="battle-log">
                    Battle started! Select your moves!
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="team-selection" id="team-selection">
        <div class="switch-prompt" id="switch-prompt">Choose a Pokémon to send out!</div>
        <div class="team-grid" id="team-grid"></div>
    </div>

    <div class="battle-end-popup" id="battle-end-popup">
        <h2 id="battle-end-title">Battle Ended!</h2>
        <p id="battle-end-message"></p>
        <div class="battle-end-buttons">
            <button class="battle-end-button continue" id="continue-battle">Continue</button>
            <button class="battle-end-button quit" id="quit-battle">Quit</button>
        </div>
    </div>

    <button class="stats-button" id="stats-button">Trainer Stats</button>

    <div class="trainer-stats-popup" id="trainer-stats-popup">
        <div class="stats-section">
            <h2>Battle Statistics</h2>
            <div class="battle-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-battles">0</div>
                    <div class="stat-label">Battles Played</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="battles-won">0</div>
                    <div class="stat-label">Battles Won</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="battles-lost">0</div>
                    <div class="stat-label">Battles Lost</div>
                </div>
            </div>
        </div>
        <div class="stats-section">
            <h2>Pokédex</h2>
            <div class="pokedex-grid" id="pokedex-grid"></div>
        </div>
    </div>

    <script>
        // Replace POKEMON_DATA with a function to generate random Kanto Pokémon
        async function generateRandomKantoPokemon() {
            const pokemonId = Math.floor(Math.random() * 151) + 1;
            const response = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonId}`);
            const data = await response.json();

            // Get moves data
            const moves = {};
            // Get 4 random moves from the Pokémon's move pool
            const availableMoves = data.moves.filter(move => move.version_group_details[0].level_learned_at <= 25);
            const selectedMoves = availableMoves
                .sort(() => Math.random() - 0.5)
                .slice(0, 4);

            // Fetch details for each selected move
            for (const move of selectedMoves) {
                showLoading(`Loading moves for ${data.name}...`);
                const moveResponse = await fetch(move.move.url);
                const moveData = await moveResponse.json();

                // Only add the move if it has power
                if (moveData.power) {
                    moves[move.move.name] = {
                        power: moveData.power,
                        priority: moveData.priority,
                        type: moveData.type.name
                    };
                }
            }

            // If we don't have 4 moves with power, add some default moves
            const defaultMoves = {
                'tackle': {
                    power: 40,
                    priority: 0,
                    type: 'normal'
                },
                'quick-attack': {
                    power: 40,
                    priority: 1,
                    type: 'normal'
                },
                'scratch': {
                    power: 40,
                    priority: 0,
                    type: 'normal'
                },
                'pound': {
                    power: 40,
                    priority: 0,
                    type: 'normal'
                }
            };

            while (Object.keys(moves).length < 4) {
                const defaultMove = Object.entries(defaultMoves)[Object.keys(moves).length];
                moves[defaultMove[0]] = defaultMove[1];
            }

            return {
                id: pokemonId,
                name: data.name.charAt(0).toUpperCase() + data.name.slice(1),
                sprite: data.sprites.front_default,
                hp: data.stats[0].base_stat,
                maxHp: data.stats[0].base_stat,
                speed: data.stats[5].base_stat,
                level: 25,
                moves: moves
            };
        }

        let POKEMON_DATA = {};
        let playerTeam = [];
        let currentOpponentTeam = [];
        let currentPlayerPokemon = 'pikachu';
        let currentOpponentPokemon = 'charizard';
        let selectedMoves = {
            player: null,
            opponent: null
        };

        const battleLog = document.getElementById('battle-log');
        const playerHealthBar = document.getElementById('player-health');
        const opponentHealthBar = document.getElementById('opponent-health');
        const turnIndicator = document.getElementById('turn-indicator');
        const teamSelection = document.getElementById('team-selection');
        const teamGrid = document.getElementById('team-grid');
        const switchPrompt = document.getElementById('switch-prompt');
        const overlay = document.getElementById('overlay');

        // Add move types to the moves
        const MOVE_TYPES = {
            'thunderbolt': 'electric',
            'quick-attack': 'normal',
            'thunder': 'electric',
            'iron-tail': 'normal',
            'flamethrower': 'fire',
            'dragon-claw': 'dragon',
            'air-slash': 'normal',
            'vine-whip': 'grass',
            'tackle': 'normal',
            'razor-leaf': 'grass',
            'seed-bomb': 'grass',
            'water-gun': 'water',
            'bubble': 'water',
            'hydro-pump': 'water',
            'aqua-tail': 'water',
            'scratch': 'normal',
            'bite': 'normal',
            'slash': 'normal',
            'pay-day': 'normal',
            'pound': 'normal',
            'double-slap': 'normal',
            'sing': 'normal',
            'body-slam': 'normal'
        };

        let battleCount = 0;
        let wins = 0;
        let encounteredPokemon = new Map();

        async function initializeTeams() {
            showLoading("Generating teams...");

            // Generate 6 random Kanto Pokémon
            for (let i = 0; i < 6; i++) {
                showLoading(`Loading Pokémon ${i + 1}/6...`);
                const pokemon = await generateRandomKantoPokemon();
                const pokemonId = `pokemon_${i}`;
                POKEMON_DATA[pokemonId] = pokemon;

                if (i < 3) {
                    playerTeam.push(pokemonId);
                    // Add to Pokédex with battle information
                    if (!encounteredPokemon.has(pokemon.name)) {
                        encounteredPokemon.set(pokemon.name, {
                            id: pokemon.id,
                            name: pokemon.name,
                            sprite: pokemon.sprite,
                            battles: [battleCount + 1], // Add current battle number
                            wins: 0,
                            losses: 0
                        });
                    } else {
                        const entry = encounteredPokemon.get(pokemon.name);
                        if (!entry.battles.includes(battleCount + 1)) {
                            entry.battles.push(battleCount + 1);
                        }
                    }
                } else {
                    currentOpponentTeam.push(pokemonId);
                }
            }

            // Set initial Pokémon
            currentPlayerPokemon = playerTeam[0];
            currentOpponentPokemon = currentOpponentTeam[0];

            // Initialize the battle
            initializeBattle();
            hideLoading();
        }

        // Modify startNewBattle to generate new random teams
        async function startNewBattle() {
            showLoading("Starting new battle...");

            // Clear existing Pokémon data
            POKEMON_DATA = {};
            playerTeam = [];
            currentOpponentTeam = [];

            // Generate new teams
            await initializeTeams();

            battleCount++;

            // Update battle log with new opponent info
            battleLog.innerHTML = '';
            logMessage(`Battle #${battleCount} started!`);
            logMessage(`Your team: ${playerTeam.map(id => POKEMON_DATA[id].name).join(', ')}`);
            logMessage(`Opponent's team: ${currentOpponentTeam.map(id => POKEMON_DATA[id].name).join(', ')}`);

            hideLoading();
        }

        function selectOpponentMove() {
            const opponentPokemon = POKEMON_DATA[currentOpponentPokemon];
            const playerPokemon = POKEMON_DATA[currentPlayerPokemon];

            // Get available moves
            const availableMoves = Object.entries(opponentPokemon.moves);

            // If player's Pokémon is low on HP, prefer high-power moves
            if (playerPokemon.hp < playerPokemon.maxHp * 0.3) {
                const highPowerMoves = availableMoves.filter(([_, move]) => move.power > 80);
                if (highPowerMoves.length > 0) {
                    return highPowerMoves[Math.floor(Math.random() * highPowerMoves.length)][0];
                }
            }

            // If opponent's Pokémon is low on HP, prefer priority moves
            if (opponentPokemon.hp < opponentPokemon.maxHp * 0.3) {
                const priorityMoves = availableMoves.filter(([_, move]) => move.priority > 0);
                if (priorityMoves.length > 0) {
                    return priorityMoves[Math.floor(Math.random() * priorityMoves.length)][0];
                }
            }

            // Otherwise, random selection with slight bias towards higher power moves
            const moveWeights = availableMoves.map(([moveId, move]) => ({
                moveId,
                weight: move.power / 100
            }));

            const totalWeight = moveWeights.reduce((sum, move) => sum + move.weight, 0);
            let random = Math.random() * totalWeight;

            for (const move of moveWeights) {
                random -= move.weight;
                if (random <= 0) {
                    return move.moveId;
                }
            }

            return availableMoves[0][0];
        }

        function updateSidebar() {
            const sidebarContent = document.getElementById('team-sidebar-content');
            sidebarContent.innerHTML = '';

            playerTeam.forEach(pokemonId => {
                const pokemon = POKEMON_DATA[pokemonId];
                const div = document.createElement('div');
                div.className = `sidebar-pokemon ${pokemon.hp <= 0 ? 'fainted' : ''} ${pokemonId === currentPlayerPokemon ? 'active' : ''}`;

                if (pokemonId === currentPlayerPokemon) {
                    div.style.pointerEvents = 'none';
                }

                div.innerHTML = `
                    <img src="${pokemon.sprite}" alt="${pokemon.name}">
                    <div class="sidebar-pokemon-info">
                        <div class="sidebar-pokemon-name">${pokemon.name}</div>
                        <div class="sidebar-pokemon-hp">
                            <div class="sidebar-pokemon-hp-fill" style="width: ${(pokemon.hp / pokemon.maxHp * 100)}%"></div>
                        </div>
                        <div>HP: ${pokemon.hp}/${pokemon.maxHp}</div>
                    </div>
                `;

                div.onclick = () => {
                    if (pokemon.hp > 0 && pokemonId !== currentPlayerPokemon) {
                        // Disable all move buttons during switch
                        document.querySelectorAll('.battle-button').forEach(button => {
                            button.disabled = true;
                        });

                        // Log the switch
                        logMessage(`${POKEMON_DATA[currentPlayerPokemon].name} was switched out!`);
                        currentPlayerPokemon = pokemonId;
                        updatePokemonDisplay('player', pokemonId);
                        updateHealthBars();
                        updateSidebar();
                        logMessage(`${pokemon.name} was sent out!`);

                        // Reset moves
                        selectedMoves = {
                            player: null,
                            opponent: null
                        };

                        // Let opponent attack after switch
                        setTimeout(() => {
                            const opponentMoves = Object.keys(POKEMON_DATA[currentOpponentPokemon].moves);
                            const randomMove = opponentMoves[Math.floor(Math.random() * opponentMoves.length)];
                            executeAttack('opponent', randomMove);

                            // Check if battle is over
                            if (!checkForFainted()) {
                                // Re-enable move buttons for next turn
                                document.querySelectorAll('.battle-button').forEach(button => {
                                    button.disabled = false;
                                });
                                turnIndicator.textContent = "Select your moves!";
                            }
                        }, 1000);
                    }
                };

                sidebarContent.appendChild(div);
            });
        }

        function initializeBattle() {
            updatePokemonDisplay('player', currentPlayerPokemon);
            updatePokemonDisplay('opponent', currentOpponentPokemon);
            updateHealthBars();
            updateSidebar();
        }

        function updatePokemonDisplay(side, pokemonId) {
            const pokemon = POKEMON_DATA[pokemonId];
            const prefix = side === 'player' ? 'player' : 'opponent';
            const pokemonElement = document.getElementById(`${prefix}-pokemon`);
            const spriteElement = document.getElementById(`${prefix}-sprite`);

            // Add switching animation
            pokemonElement.classList.add('switching-out');

            setTimeout(() => {
                // Update Pokémon data
                spriteElement.src = pokemon.sprite;
                document.getElementById(`${prefix}-name`).textContent = pokemon.name;
                document.getElementById(`${prefix}-level`).textContent = `Level ${pokemon.level}`;
                document.getElementById(`${prefix}-stats`).textContent =
                    `HP: ${pokemon.hp}/${pokemon.maxHp} | Speed: ${pokemon.speed}`;

                // Update moves
                const movesContainer = document.getElementById(`${prefix}-moves`);
                movesContainer.innerHTML = '';
                Object.entries(pokemon.moves).forEach(([moveId, moveData]) => {
                    const button = document.createElement('button');
                    button.className = 'battle-button';
                    button.textContent = moveId.split('-').map(word =>
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    button.onclick = () => selectMove(side, moveId);
                    movesContainer.appendChild(button);
                });

                // Remove switching-out class and add switching-in class
                pokemonElement.classList.remove('switching-out');
                pokemonElement.classList.add('switching-in');

                // Remove switching-in class after animation
                setTimeout(() => {
                    pokemonElement.classList.remove('switching-in');
                }, 500);
            }, 500);
        }

        function updateHealthBars() {
            const playerPokemon = POKEMON_DATA[currentPlayerPokemon];
            const opponentPokemon = POKEMON_DATA[currentOpponentPokemon];

            playerHealthBar.style.width = (playerPokemon.hp / playerPokemon.maxHp * 100) + '%';
            opponentHealthBar.style.width = (opponentPokemon.hp / opponentPokemon.maxHp * 100) + '%';

            document.getElementById('player-stats').textContent =
                `HP: ${playerPokemon.hp}/${playerPokemon.maxHp} | Speed: ${playerPokemon.speed}`;
            document.getElementById('opponent-stats').textContent =
                `HP: ${opponentPokemon.hp}/${opponentPokemon.maxHp} | Speed: ${opponentPokemon.speed}`;

            updateSidebar();
        }

        function showTeamSelection(isPlayer) {
            const team = isPlayer ? playerTeam : opponentTeam;
            const currentPokemon = isPlayer ? currentPlayerPokemon : currentOpponentPokemon;

            teamGrid.innerHTML = '';
            team.forEach(pokemonId => {
                        const pokemon = POKEMON_DATA[pokemonId];
                        const div = document.createElement('div');
                        div.className = `team-pokemon ${pokemon.hp <= 0 ? 'fainted' : ''}`;
                        if (pokemonId === currentPokemon || pokemon.hp <= 0) {
                            div.style.pointerEvents = 'none';
                        }

                        div.innerHTML = `
                    <img src="${pokemon.sprite}" alt="${pokemon.name}">
                    <div>${pokemon.name}</div>
                    <div class="pokemon-status">${pokemon.hp <= 0 ? 'Fainted' : `HP: ${pokemon.hp}/${pokemon.maxHp}`}</div>
                `;
                
                div.onclick = () => {
                    if (pokemon.hp > 0 && pokemonId !== currentPokemon) {
                        if (isPlayer) {
                            currentPlayerPokemon = pokemonId;
                        } else {
                            currentOpponentPokemon = pokemonId;
                        }
                        updatePokemonDisplay(isPlayer ? 'player' : 'opponent', pokemonId);
                        updateHealthBars();
                        
                        // Ensure both the team selection and overlay are removed
                        teamSelection.classList.remove('active');
                        overlay.classList.remove('active');
                        
                        logMessage(`${pokemon.name} was sent out!`);
                        
                        // Reset moves for both sides when a Pokémon is switched out
                        selectedMoves = {
                            player: null,
                            opponent: null
                        };
                        
                        // Re-enable all move buttons
                        document.querySelectorAll('.battle-button').forEach(button => {
                            button.disabled = false;
                        });
                        
                        turnIndicator.textContent = "Select your moves!";
                    }
                };
                
                teamGrid.appendChild(div);
            });
            
            switchPrompt.textContent = `${isPlayer ? 'Player' : 'Opponent'} must choose a Pokémon to send out!`;
            teamSelection.classList.add('active');
            overlay.classList.add('active');
        }

        function selectMove(side, move) {
            if (side === 'player') {
                selectedMoves.player = move;
                logMessage(`${POKEMON_DATA[currentPlayerPokemon].name} selected ${move.replace('-', ' ')}!`);

                // Disable all moves for player
                document.querySelectorAll('#player-moves .battle-button').forEach(button => {
                    button.disabled = true;
                });

                // AI opponent selects move
                const opponentMove = selectOpponentMove();
                selectedMoves.opponent = opponentMove;
                logMessage(`${POKEMON_DATA[currentOpponentPokemon].name} selected ${opponentMove.replace('-', ' ')}!`);

                // Execute turns
                executeTurns();
            }
        }

        function executeTurns() {
            const playerMove = POKEMON_DATA[currentPlayerPokemon].moves[selectedMoves.player];
            const opponentMove = POKEMON_DATA[currentOpponentPokemon].moves[selectedMoves.opponent];

            let firstAttacker, secondAttacker;
            let firstMove, secondMove;

            if (playerMove.priority > opponentMove.priority) {
                firstAttacker = 'player';
                secondAttacker = 'opponent';
                firstMove = selectedMoves.player;
                secondMove = selectedMoves.opponent;
            } else if (opponentMove.priority > playerMove.priority) {
                firstAttacker = 'opponent';
                secondAttacker = 'player';
                firstMove = selectedMoves.opponent;
                secondMove = selectedMoves.player;
            } else {
                const playerSpeed = POKEMON_DATA[currentPlayerPokemon].speed;
                const opponentSpeed = POKEMON_DATA[currentOpponentPokemon].speed;

                if (playerSpeed >= opponentSpeed) {
                    firstAttacker = 'player';
                    secondAttacker = 'opponent';
                    firstMove = selectedMoves.player;
                    secondMove = selectedMoves.opponent;
                } else {
                    firstAttacker = 'opponent';
                    secondAttacker = 'player';
                    firstMove = selectedMoves.opponent;
                    secondMove = selectedMoves.player;
                }
            }

            // Execute first attack with delay
            setTimeout(() => {
                executeAttack(firstAttacker, firstMove);
                
                // Check if battle is over after first attack
                setTimeout(() => {
                    if (!checkForFainted()) {
                        // Execute second attack with delay
                        setTimeout(() => {
                            executeAttack(secondAttacker, secondMove);
                            
                            // Check if battle is over after second attack
                            setTimeout(() => {
                                if (!checkForFainted()) {
                                    // Reset for next turn
                                    resetTurn();
                                }
                            }, 1500);
                        }, 1500);
                    }
                }, 1500);
            }, 500);
        }

        function createAnimation(type, targetElement) {
            // Don't create animation if the target Pokémon is fainted
            const isPlayer = targetElement.id === 'player-pokemon';
            const currentPokemon = isPlayer ? currentPlayerPokemon : currentOpponentPokemon;
            if (POKEMON_DATA[currentPokemon].hp <= 0) {
                return;
            }

            const animation = document.createElement('div');
            animation.className = `battle-animation ${type}-animation`;
            
            const rect = targetElement.getBoundingClientRect();
            const battleScene = document.querySelector('.battle-scene');
            const battleRect = battleScene.getBoundingClientRect();
            
            animation.style.left = `${rect.left - battleRect.left + rect.width/2 - 50}px`;
            animation.style.top = `${rect.top - battleRect.top + rect.height/2 - 50}px`;
            
            battleScene.appendChild(animation);
            
            // Remove animation after it completes
            animation.addEventListener('animationend', () => {
                animation.remove();
            });
        }

        function executeAttack(attacker, move) {
            const attackerPokemon = attacker === 'player' ? currentPlayerPokemon : currentOpponentPokemon;
            const defenderPokemon = attacker === 'player' ? currentOpponentPokemon : currentPlayerPokemon;
            
            const moveData = POKEMON_DATA[attackerPokemon].moves[move];
            const damage = Math.floor(moveData.power * (0.8 + Math.random() * 0.4));
            const attackerSprite = document.getElementById(`${attacker}-sprite`);
            const defenderElement = document.getElementById(`${attacker === 'player' ? 'opponent' : 'player'}-pokemon`);
            const defenderHealthBar = document.getElementById(`${attacker === 'player' ? 'opponent' : 'player'}-health`);
            
            // Log the attack with move type
            logMessage(`${POKEMON_DATA[attackerPokemon].name} used ${move.replace('-', ' ')}!`);
            
            // Add attack jump animation to attacker's sprite
            attackerSprite.classList.add('attacking');
            
            // Remove attack animation after it completes
            setTimeout(() => {
                attackerSprite.classList.remove('attacking');
                
                // Add hit animation to defender
                defenderElement.classList.add('hit');
                
                // Calculate new HP, ensuring it doesn't go below 0
                const oldHp = POKEMON_DATA[defenderPokemon].hp;
                const newHp = Math.max(0, oldHp - damage);
                POKEMON_DATA[defenderPokemon].hp = newHp;
                
                // Animate HP bar decrease
                const startTime = Date.now();
                const duration = 1000; // 1 second animation
                
                function animateHP() {
                    const currentTime = Date.now();
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Calculate current HP value during animation, ensuring it doesn't go below 0
                    const currentHp = Math.max(0, Math.floor(oldHp - (damage * progress)));
                    const hpPercentage = (currentHp / POKEMON_DATA[defenderPokemon].maxHp) * 100;
                    
                    // Update HP bar
                    defenderHealthBar.style.width = `${hpPercentage}%`;
                    
                    // Update stats display
                    document.getElementById(`${attacker === 'player' ? 'opponent' : 'player'}-stats`).textContent = 
                        `HP: ${currentHp}/${POKEMON_DATA[defenderPokemon].maxHp} | Speed: ${POKEMON_DATA[defenderPokemon].speed}`;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateHP);
                    } else {
                        // Animation complete
                        const actualDamage = oldHp - currentHp;
                        logMessage(`Dealt ${actualDamage} damage!`);
                        if (currentHp === 0) {
                            logMessage(`${POKEMON_DATA[defenderPokemon].name} fainted!`);
                        }
                        updateSidebar();
                    }
                }
                
                // Start HP animation
                setTimeout(() => {
                    animateHP();
                }, 500); // Wait for hit animation to complete
                
                // Remove hit animation after delay
                setTimeout(() => {
                    defenderElement.classList.remove('hit');
                }, 300);
            }, 500); // Wait for attack animation to complete
        }

        function checkForFainted() {
            if (POKEMON_DATA[currentPlayerPokemon].hp <= 0) {
                logMessage(`${POKEMON_DATA[currentPlayerPokemon].name} fainted!`);
                if (playerTeam.some(p => POKEMON_DATA[p].hp > 0)) {
                    showTeamSelection(true);
                    return true;
                } else {
                    endBattle(false);
                    return true;
                }
            }
            
            if (POKEMON_DATA[currentOpponentPokemon].hp <= 0) {
                logMessage(`${POKEMON_DATA[currentOpponentPokemon].name} fainted!`);
                if (currentOpponentTeam.some(p => POKEMON_DATA[p].hp > 0)) {
                    // Add switching-out animation to current opponent Pokémon
                    const currentOpponentElement = document.getElementById('opponent-pokemon');
                    currentOpponentElement.classList.add('switching-out');
                    
                    // Wait for switch-out animation to complete
                    setTimeout(() => {
                        // AI opponent switches to next available Pokémon
                        const nextPokemon = currentOpponentTeam.find(p => POKEMON_DATA[p].hp > 0);
                        if (nextPokemon) {
                            currentOpponentPokemon = nextPokemon;
                            updatePokemonDisplay('opponent', nextPokemon);
                            updateHealthBars();
                            logMessage(`${POKEMON_DATA[nextPokemon].name} was sent out!`);
                            
                            // Reset moves for next turn
                            selectedMoves = {
                                player: null,
                                opponent: null
                            };
                            
                            // Re-enable all move buttons
                            document.querySelectorAll('.battle-button').forEach(button => {
                                button.disabled = false;
                            });
                            
                            turnIndicator.textContent = "Select your moves!";
                        }
                    }, 500); // Wait for switch-out animation to complete
                    return true;
                } else {
                    endBattle(true);
                    return true;
                }
            }
            
            return false;
        }

        function resetTurn() {
            selectedMoves = {
                player: null,
                opponent: null
            };

            // Re-enable all move buttons
            document.querySelectorAll('.battle-button').forEach(button => {
                button.disabled = false;
            });

            turnIndicator.textContent = "Select your moves!";
        }

        function endBattle(playerWon) {
            if (playerWon) {
                wins++;
                logMessage(`You won the battle! (Wins: ${wins}/${battleCount})`);
                // Update wins for all Pokémon in current team
                playerTeam.forEach(pokemonId => {
                    const pokemon = POKEMON_DATA[pokemonId];
                    const entry = encounteredPokemon.get(pokemon.name);
                    if (entry) {
                        entry.wins++;
                    }
                });
            } else {
                logMessage(`You lost the battle! (Wins: ${wins}/${battleCount})`);
                // Update losses for all Pokémon in current team
                playerTeam.forEach(pokemonId => {
                    const pokemon = POKEMON_DATA[pokemonId];
                    const entry = encounteredPokemon.get(pokemon.name);
                    if (entry) {
                        entry.losses++;
                    }
                });
            }
            
            document.querySelectorAll('.battle-button').forEach(button => {
                button.disabled = true;
            });

            // Show battle end popup
            const popup = document.getElementById('battle-end-popup');
            const title = document.getElementById('battle-end-title');
            const message = document.getElementById('battle-end-message');
            
            title.textContent = playerWon ? 'Victory!' : 'Defeat!';
            message.textContent = playerWon 
                ? `You won the battle! Your record: ${wins} wins out of ${battleCount} battles.`
                : `You lost the battle! Your record: ${wins} wins out of ${battleCount} battles.`;
            
            popup.classList.add('active');
            overlay.classList.add('active');

            // Add event listeners to buttons
            document.getElementById('continue-battle').onclick = () => {
                popup.classList.remove('active');
                overlay.classList.remove('active');
                startNewBattle();
            };

            document.getElementById('quit-battle').onclick = () => {
                popup.classList.remove('active');
                overlay.classList.remove('active');
                window.location.reload();
            };
        }

        function logMessage(message) {
            battleLog.innerHTML += `<div>${message}</div>`;
            battleLog.scrollTop = battleLog.scrollHeight;
        }

        // Add loading management functions
        function showLoading(message) {
            const overlay = document.getElementById('loading-overlay');
            const loadingText = document.getElementById('loading-text');
            overlay.style.display = 'flex';
            loadingText.textContent = message;
        }

        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
        }

        // Add trainer stats management
        function updateTrainerStats() {
            document.getElementById('total-battles').textContent = battleCount;
            document.getElementById('battles-won').textContent = wins;
            document.getElementById('battles-lost').textContent = battleCount - wins;
            
            // Update Pokédex
            const pokedexGrid = document.getElementById('pokedex-grid');
            pokedexGrid.innerHTML = '';
            
            // Sort Pokémon by ID and create entries
            Array.from(encounteredPokemon.values())
                .sort((a, b) => a.id - b.id)
                .forEach(pokemon => {
                    const entry = document.createElement('div');
                    entry.className = 'pokedex-entry';
                    entry.innerHTML = `
                        <img src="${pokemon.sprite}" alt="${pokemon.name}">
                        <div class="pokemon-name">${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)}</div>
                        <div class="pokemon-stats">
                            <div>Battles: ${pokemon.battles.join(', ')}</div>
                            <div>Record: ${pokemon.wins}W - ${pokemon.losses}L</div>
                        </div>
                    `;
                    pokedexGrid.appendChild(entry);
                });
        }

        // Add event listeners for the stats button
        document.getElementById('stats-button').addEventListener('click', () => {
            updateTrainerStats();
            document.getElementById('trainer-stats-popup').classList.add('active');
            overlay.classList.add('active');
        });

        // Update the overlay click handler to close the stats popup
        overlay.addEventListener('click', () => {
            teamSelection.classList.remove('active');
            document.getElementById('trainer-stats-popup').classList.remove('active');
            overlay.classList.remove('active');
        });

        // Initialize the game
        startNewBattle();
    </script>
</body>

</html>